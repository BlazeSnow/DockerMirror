name: Docker Mirror

on:
  workflow_dispatch:
  schedule:
  - cron: "0 16 * * *"

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: blazesnow
  USERNAME: BlazeSnow23

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        image:
        - source: hello-world:latest
          target: hello-world:latest
        - source: fauria/vsftpd:latest
          target: vsftpd:latest
        - source: atmoz/sftp:latest
          target: sftp:latest
        - source: bytemark/webdav:latest
          target: webdav:latest
        - source: dockurr/samba:latest
          target: samba:latest
        - source: itsthenetwork/nfs-server-alpine:latest
          target: nfs-server-alpine:latest
        - source: itzg/minecraft-server:latest
          target: minecraft-server:latest
        - source: adguard/adguardhome:latest
          target: adguardhome:latest
        - source: vaultwarden/server:latest
          target: vaultwarden_server:latest
        - source: caddy:alpine
          target: caddy:alpine
        - source: lanol/filecodebox:latest
          target: filecodebox:latest
        - source: binwiederhier/ntfy:latest
          target: ntfy:latest
        - source: homeassistant/home-assistant:stable
          target: home-assistant:stable
        - source: teamspeak:latest
          target: teamspeak:latest
        - source: deluan/navidrome:latest
          target: navidrome:latest
        - source: portainer/portainer-ce:alpine
          target: portainer-ce:alpine
        - source: portainer/agent:alpine
          target: portainer-agent:alpine
        - source: busybox:latest
          target: busybox:latest

    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: login
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.USERNAME }}
        password: ${{ secrets.TOKEN }}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: chmod
      run: chmod +x ./dockermirror.sh

    - name: docker pull, tag, push and clean
      env:
        SOURCE: ${{ matrix.image.source }}
        TARGET: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.image.target }}
      run: ./dockermirror.sh
