name: Docker Mirror

on:
  push:
    branches:
    - main
  workflow_dispatch:
  schedule:
  - cron: "0 16 * * *"

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: blazesnow
  USERNAME: BlazeSnow23

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        image:
        - source: hello-world
          target: hello-world
        - source: fauria/vsftpd
          target: vsftpd
        - source: atmoz/sftp
          target: sftp
        - source: bytemark/webdav
          target: webdav
        - source: dockurr/samba
          target: samba
        - source: itsthenetwork/nfs-server-alpine
          target: nfs-server-alpine
        - source: itzg/minecraft-server
          target: minecraft-server
        - source: adguard/adguardhome
          target: adguardhome
        - source: vaultwarden/server
          target: vaultwarden_server
        - source: caddy:alpine
          target: caddy:alpine
        - source: lanol/filecodebox
          target: filecodebox
        - source: binwiederhier/ntfy
          target: ntfy
        - source: homeassistant/home-assistant:stable
          target: home-assistant:stable
        - source: teamspeak
          target: teamspeak
        - source: deluan/navidrome
          target: navidrome
        - source: portainer/portainer-ce:alpine
          target: portainer-ce:alpine
        - source: portainer/agent:alpine
          target: portainer-agent:alpine
        - source: busybox
          target: busybox

    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: login
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.USERNAME }}
        password: ${{ secrets.TOKEN }}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: chmod
      run: chmod +x ./dockermirror.sh

    - name: docker pull, tag, push and clean
      env:
        SOURCE: docker.io/${{ matrix.image.source }}
        TARGET: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.image.target }}
      run: ./dockermirror.sh
